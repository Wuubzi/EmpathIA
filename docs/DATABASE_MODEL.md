# Modelo de Datos – EmpathIA

Compact relational schema intended for the EmpathIA MVP. The tables and fields below are a guidance baseline; adapt names, types and constraints to project conventions, Supabase/Postgres requirements, and local compliance needs.

## Tablas principales

### USUARIOS
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_usuario | SERIAL PRIMARY KEY | Identificador interno |
| nombre_completo | VARCHAR(150) | NOT NULL |
| email | VARCHAR(150) | UNIQUE, NULLABLE |
| ciudad | VARCHAR(100) | NULLABLE |
| departamento | VARCHAR(100) | NULLABLE |
| activo | BOOLEAN | DEFAULT TRUE |

### PUBLICACIONES
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_publicacion | SERIAL PRIMARY KEY | |
| id_usuario | INTEGER | FK → USUARIOS(id_usuario) |
| contenido_texto | TEXT | NOT NULL |
| fecha_publicacion | TIMESTAMP WITH TIME ZONE | DEFAULT now() |

### ANALISIS_RIESGO
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_analisis | SERIAL PRIMARY KEY | |
| id_publicacion | INTEGER | FK → PUBLICACIONES(id_publicacion) |
| nivel_riesgo | VARCHAR(10) | CHECK (nivel_riesgo IN ('LOW','MEDIUM','HIGH')) |
| puntuacion_riesgo | DECIMAL(5,2) | 0.00 - 100.00 |
| alert_triggered | BOOLEAN | DEFAULT FALSE |
| analysis_id | UUID | UNIQUE, recomendado para cross-referencias |

### ALERTAS
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_alerta | SERIAL PRIMARY KEY | |
| id_analisis | INTEGER | FK → ANALISIS_RIESGO(id_analisis) |
| id_usuario | INTEGER | FK → USUARIOS(id_usuario) |
| nivel_urgencia | VARCHAR(20) | NOT NULL |
| mensaje_alerta | TEXT | NOT NULL |

### PROFESIONALES_APOYO
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_profesional | SERIAL PRIMARY KEY | |
| nombre_completo | VARCHAR(150) | NOT NULL |
| especialidad | VARCHAR(100) | NULLABLE |
| email | VARCHAR(150) | UNIQUE, NULLABLE |
| disponible | BOOLEAN | DEFAULT TRUE |

### CONTACTOS_EMERGENCIA
| Campo | Tipo | Restricciones |
|---|---:|---|
| id_contacto | SERIAL PRIMARY KEY | |
| id_usuario | INTEGER | FK → USUARIOS(id_usuario) |
| nombre_contacto | VARCHAR(150) | NOT NULL |
| telefono | VARCHAR(25) | NOT NULL |
| acepta_recibir_alertas | BOOLEAN | DEFAULT TRUE |

## Notes and operational guidance

- Use `analysis_id` (UUID) as a correlation identifier across services and LLM calls. This value should be generated by the MCP gateway when a new analysis request is received.
- Avoid storing raw personally-identifying information when it is not required. Prefer storing a hashed user identifier (for example, HMAC-SHA256 using a server-side secret) to enable linking analysis history while preserving privacy.
- Version database schema changes and document them in `docs/REFERENCE.md`. Use migration tooling (for example, Flyway or Liquibase) as part of backend CI/CD to apply ordered, auditable schema updates.
- Recommended indexes:
	- `ANALISIS_RIESGO (analysis_id)` — unique index for cross-service lookup.
	- `PUBLICACIONES (id_usuario)` — to efficiently query a user's posts.
	- `ALERTAS (id_analisis, id_usuario)` — composite index for alert queries.
- Retention and archival policy:
	- Store detailed analysis records for a configurable retention window (e.g., 90–365 days) depending on legal and product requirements.
	- After the retention window, archive aggregated metrics and remove or anonymize detailed text content. Store sanitized metadata needed for audits.
- Audit logging and traceability:
	- Keep an audit log table or external audit stream that records: `analysis_id`, `operation` (create/read/update), `actor` (service or user), `timestamp`, and `reason` for manual overrides.
	- Attach model metadata to each persisted analysis: `model_version`, `prompt_template_id`, and `confidence`.
- Privacy and compliance:
	- Encrypt at rest for sensitive columns where required by regulation (for example, contact phone numbers).
	- Expose APIs to support data subject requests (export/delete) in accordance with applicable privacy laws.

